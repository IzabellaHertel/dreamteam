var app=angular.module("app",["ui.bootstrap","ui.router","ngStorage","luegg.directives","btford.socket-io"]);app.config(["$stateProvider","$locationProvider","$urlRouterProvider",function(e,s,a){a.otherwise("/login"),e.state({name:"login",url:"/login",templateUrl:"partials/login.html",controller:"loginController",css:"css/style.css"}).state({name:"register",url:"/register",templateUrl:"partials/register.html",controller:"registerController",css:"css/style.css"}).state("chat",{url:"/chat",templateUrl:"partials/chat.html",controller:"chatController",css:"css/style.css"}).state("adminuserlist",{url:"/adminuserlist",templateUrl:"partials/adminuserlist.html",controller:"adminuserlistController",css:"css/style.css"}).state("chat.private",{url:"/private",templateUrl:"partials/private.html",css:"css/style.css"}).state("chat.public",{url:"/public",templateUrl:"partials/public.html",css:"css/style.css"}).state("chat.search",{url:"/search",templateUrl:"partials/search-results.html",css:"css/style.css"})}]),app.value("avatars",[{name:"Zombie",src:"assets/img/av02.png"},{name:"Zebra",src:"assets/img/av01.png"},{name:"Worm",src:"assets/img/av03.png"},{name:"Cool Giraffe",src:"assets/img/av04.png"},{name:"Weird unicorn",src:"assets/img/av05.png"},{name:"Fly",src:"assets/img/av06.png"},{name:"Leopard",src:"assets/img/av07.png"},{name:"Rico Tequila",src:"assets/img/av08.png"},{name:"Mr. french fries",src:"assets/img/av09.png"},{name:"coco crayfish",src:"assets/img/av10.png"},{name:"Doggy style",src:"assets/img/av11.png"}]),app.controller("sidebarController",["$scope","$location","$sessionStorage",function(e,s,a){e.username=a.username,e.avatar=a.avatar}]),app.controller("chatController",["$scope","$location","$http","$sessionStorage","$interval","avatars","chatSocket","validation","$timeout","$state",function(e,s,a,t,r,n,o,i,c,l){function u(){delete t.id,delete t.username,delete t.avatar,delete t.reciever}e.username=t.username,e.avatar=t.avatar,e.id=t.id,e.password=t.password,e.avatars=n,e.unregisterNow=!1,e.unregisterAccountModal=function(){e.unregisterNow=!e.unregisterNow},e.edit=!1,e.editProfile=function(){e.edit=!e.edit},e.changePassword=!1,e.editPassword=function(){e.changePassword=!e.changePassword},e.changeAvatarModal=!1,e.editAvatar=function(){e.changeAvatarModal=!e.changeAvatarModal},e.isUserSender=function(e){return e===t.username},e.successfyllyChangedPassword=!1,e.changeYourPassword=function(s){e.users.password&&a.put("/users/password/"+s,e.users).then(function(s){e.successfyllyChangedPassword=!0,t.password=e.users.password,c(function(){e.confirmOldPassword=!0,e.chooseNewPassword=!1,e.changePassword=!1,e.successfyllyChangedPassword=!1,e.users.password="",e.confirmNewPassword="",l.reload()},1500)})},e.successfyllyChangedAvatar=!1,e.changeAvatar=function(s){e.users.avatar&&a.put("/users/avatar/"+s,e.users).then(function(s){t.avatar=e.users.avatar.src,e.successfyllyChangedAvatar=!0,c(function(){l.reload()},1e3)})},e.successfyllyUnregistered=!1,e.unregisterAccount=function(r){e.wrongPassword=!1,e.unregisterPasswordConfirm==t.password?a.delete("/users/3/"+r).then(function(a){e.successfyllyUnregistered=!0,c(function(){u(),s.path("/login")},1e3)}):e.wrongPassword=!0},e.confirmOldPassword=!0,e.correctPassword=function(){e.chooseNewPassword=!1,e.incorrectPassword=!1,e.oldPassword==t.password?(e.chooseNewPassword=!0,e.confirmOldPassword=!1,e.oldPassword=""):e.incorrectPassword=!0},e.$watch("users.password",function(s,a){s&&(e.tooLong=i.long(s),e.tooShort=i.short(s),e.regex=i.regex(s))}),function(){a.get("/conversations").then(function(s){e.allMessages=s.data})}(),e.sendMessage=function(){e.conversations&&(e.conversations.messages.sender=t.username,e.conversations.messages.senderavatar=t.avatar,e.conversations.messages.date=new Date),a.post("/conversations",e.conversations).then(function(s){e.conversations.messages.content=""})},o.addListener("new message",function(s){e.allMessages.push(s)}),e.privateMessage={},e.sendPrivateMessage=function(){e.privateMessage&&(e.privateMessage.sender=t.username,e.privateMessage.reciever=t.reciever,e.privateMessage.senderavatar=t.avatar,e.privateMessage.date=new Date),a.post("/privateMessage",e.privateMessage).then(function(s){e.privateMessage.content="",e.getPrivateConversation(t.recieverid)})},e.goToSearch=function(){s.path("/chat/search")},e.adminUserList=function(){s.path("/adminuserlist")},function(){a.get("/users").then(function(s){e.userList=s.data})}(),e.getPrivateConversation=function(r){delete t.reciever,delete t.recieverid,t.recieverid=r,a.get("/users").then(function(s){for(var a=0;a<s.data.length;a++)s.data[a]._id===r&&(t.reciever=s.data[a].username,e.chatWith=t.reciever)}),s.path("/chat/private"),function(){e.privateConversation=[],a.get("/privateMessage").then(function(s){for(var a=0;a<s.data.length;a++)t.username===s.data[a].sender&&t.reciever===s.data[a].reciever?e.privateConversation.push(s.data[a]):t.username===s.data[a].reciever&&t.reciever===s.data[a].sender&&e.privateConversation.push(s.data[a])})}()},e.logout=function(){a.put("/users/1/"+t.id,e.users).then(function(e){}),u(),s.path("/login")},e.adminUserList=function(){s.path("/adminuserlist")},e.showSidebar=function(){$(this).toggleClass("fa-bars fa-close"),$("#sidebar").slideToggle().css("display","block")}}]),app.controller("adminuserlistController",["$scope","$location","$http","$sessionStorage",function(e,s,a,t){function r(){a.get("/users").then(function(s){e.userList=s.data,e.users=null})}r(),e.removeUser=function(s){var t=document.getElementById("delete-modal");t.style.display="block",window.onclick=function(e){e.target==t&&(t.style.display="none")},e.id=s,a.get("/users/"+s).then(function(s){e.users=s.data})},e.modalDelete=function(){var s=e.id;a.delete("/users/"+s).then(function(s){e.users=s.data,r()}),document.getElementById("delete-modal").style.display="none"},e.cancel=function(){document.getElementById("delete-modal").style.display="none"},e.registerBack=function(){s.path("/register")},e.loginBack=function(){s.path("/login")},e.chatBack=function(){s.path("/chat/public")}}]),app.controller("loginController",["$scope","$location","$http","$sessionStorage",function(e,s,a,t){e.logIn=function(){e.users&&(e.errorMessagePassword=!1,e.errorMessageUsername=!1,a.get("/users").then(function(r){for(var n=0;n<r.data.length;n++){if(e.users.username===r.data[n].username)return e.users.password===r.data[n].password?(s.path("/chat/public"),e.errorMessageUsername=!1,t.id=r.data[n]._id,t.username=r.data[n].username,t.avatar=r.data[n].avatar.src,t.password=r.data[n].password,void a.put("/users/"+t.id)):(e.errorMessageUsername=!1,void(e.errorMessagePassword=!0));e.errorMessageUsername=!0}}))}}]),app.factory("validation",[function(){return{long:function(e){return e.length>30},short:function(e){return e.length<5},regex:function(e){return!/^[0-9a-zA-Z]+$/.test(e)}}}]),app.directive("avatarDropdown",[function(){return{restrict:"E",templateUrl:"../../templates/avatar-dropdown.html"}}]),app.directive("showPasswordEye",[function(){return{restrict:"E",templateUrl:"../../templates/show-password.html"}}]),app.factory("chatSocket",["socketFactory",function(e){return e()}]),app.controller("registerController",["$scope","$location","$http","validation","avatars",function(e,s,a,t,r){e.$watch("users.username",function(s,r){s&&(e.tooLong=t.long(s),e.tooShort=t.short(s),e.regex=t.regex(s),e.usernameIsTaken=!1,a.get("/users").then(function(a){for(var t=0;t<a.data.length;t++)s==a.data[t].username&&(e.usernameIsTaken=!0)})),e.$watch("users.password",function(s,a){s&&(e.tooShortPassword=t.short(s),e.tooLongPassword=t.long(s),e.passwordRegex=t.regex(s))})}),e.avatars=r,e.users={},e.users.avatar=e.avatars[10],e.users.online=!1,e.registerSubmit=function(){a.post("/users",e.users).then(function(e){var s=document.getElementById("login-modal");s.style.display="block",window.onclick=function(e){e.target==s&&(s.style.display="none")}})},e.modalLogin=function(){s.path("login")}}]);